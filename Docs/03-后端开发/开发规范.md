# LinkGateway 开发规范与指南

## 1. 项目概述

LinkGateway是基于FastAPI的后端微服务架构**核心通信组件**，作为所有服务和引擎的统一入口，负责服务发现、API映射、服务间通信和请求路由。它支持业务服务和引擎服务的注册与发现，并提供统一的API访问入口，确保所有组件间通信的安全性、可监控性和可管理性。

## 2. 架构设计

### 2.1 核心组件

- **LinkGateway**：**核心通信枢纽**，所有组件间通信必须通过LinkGateway进行，负责服务发现、API映射、请求路由和通信管理
- **BaseEngine**：引擎基础框架，定义了引擎的基本接口和行为规范，包含统一的引擎接口标准
- **业务服务**：包含业务逻辑的服务组件，可放置在services目录下任意位置，需包含service.json配置文件
- **引擎服务**：功能引擎组件，分为kernel引擎（内部使用）和network引擎（外部访问）

### 2.2 目录结构

```
my_blog_backend/
├── BaseEngine/           # 引擎基础框架
│   ├── base.py           # 引擎基类定义
│   ├── engine_registry.py # 引擎注册表
├── LinkGateway/          # LinkGateway核心实现
│   ├── api_mapper.py     # API映射与路由管理
│   ├── gateway.py        # 核心网关类
│   ├── logs.py           # 日志管理
│   ├── path_manager.py   # 路径管理
│   ├── plugin.py         # 插件管理
│   ├── registry.py       # 服务注册与发现
│   ├── service_proxy.py  # 服务代理
├── data/                 # 统一数据存储目录
│   ├── linkgateway/      # LinkGateway核心数据库
│   ├── services/         # 业务服务数据目录
│   │   └── {service_id}/ # 各服务的数据目录
│   └── engines/          # 引擎数据目录
├── engines/              # 引擎实现目录
├── log/                  # 统一日志目录
│   ├── linkgateway/      # LinkGateway日志
│   ├── services/         # 服务日志
│   └── engines/          # 引擎日志
├── plugins/              # 插件目录
├── services/             # 业务服务目录
├── main.py               # 应用入口
├── pyproject.toml        # 项目配置
└── uv.lock               # 依赖锁文件
```

## 3. 命名规范

### 3.1 服务命名

- 业务服务：根据功能命名，使用小写字母和下划线/连字符，如`user-service`或`user_business`
- 引擎服务：根据功能命名，使用小写字母和下划线，如`example_engine`

### 3.2 API路径

- 业务服务：`/api/{service_id}/{api_path}`，如`/api/user-service/users`
- 引擎服务：`/api/{engine_name}/{api_path}`，如`/api/example_engine/test`
- API路径自动标准化，确保格式一致

### 3.3 文件命名

- 配置文件：业务服务使用`service.json`，引擎服务使用`{engine_name}.json`
- Python文件：使用小写字母和下划线，如`engine_registry.py`
- 类名：使用驼峰命名法，如`ServiceRegistry`
- 函数和变量名：使用小写字母和下划线，如`discover_services`

## 4. 代码组织规范

### 4.1 模块化设计

- 每个功能模块独立成文件或目录，职责单一
- 模块间通过清晰的接口通信，避免循环依赖
- 遵循高内聚、低耦合原则

### 4.2 数据验证

- 使用Pydantic进行数据验证
- 定义清晰的数据模型
- 验证所有输入数据

### 4.3 异常处理

- 实现统一的异常处理机制
- 提供清晰的错误信息
- 适当记录错误日志

### 4.4 注释和文档

- 为每个类、函数和方法添加文档字符串
- 复杂逻辑添加注释说明
- 保持注释与代码同步更新

## 4. 代码质量标准

### 4.1 代码复杂度控制
- **嵌套层级限制**：方法嵌套层级最多 3 层，循环嵌套层级最多 2 层
- **方法长度限制**：单个方法不超过 50 行，单个类不超过 300 行
- **认知复杂度限制**：认知复杂度不超过 10
- **圈复杂度限制**：圈复杂度不超过 10

### 4.2 代码可读性标准
- **命名规范**：
  - 类名：大驼峰（PascalCase）
  - 方法/函数名：小驼峰（camelCase）
  - 常量：全大写下划线（UPPER_SNAKE_CASE）
  - 私有方法/属性：单下划线前缀（_private_method）
  
- **代码结构**：
  - 文件长度：单个文件不超过 500 行
  - 导入顺序：标准库 → 第三方库 → 本地模块
  - 代码组织：相关功能放在同一模块，按功能分层
  
- **代码风格**：
  - 守护判断：使用平行等级的 if 判断，早暴露早解决问题
  - 提前返回：验证失败立即返回，避免深层嵌套
  - 单一职责：每个方法只做一件事
  - 逻辑复用：消除重复代码，提取公共方法

### 4.3 异常处理规范
- **异常捕获**：明确捕获特定异常类型，避免使用裸 except
- **异常处理**：提供清晰的错误信息，记录日志
- **异常传播**：适当传播异常，不要吞掉异常
- **资源清理**：使用 finally 或上下文管理器确保资源释放

### 4.4 文档字符串规范
- **文档字符串要求**：所有公共方法必须有 Google 风格文档字符串
- **文档内容**：包含 Args、Returns、Raises、Examples
- **注释规范**：复杂逻辑添加注释说明，不要注释显而易见的代码

### 4.5 测试规范
- **测试覆盖**：核心逻辑必须有单元测试，测试覆盖率不低于 80%
- **测试文件命名**：test_xxx.py
- **测试编写原则**：AAA 模式（Arrange、Act、Assert）

### 4.6 反模式（Anti-Patterns）
必须避免的反模式：
- ❌ 深层嵌套（超过 3 层）
- ❌ 过长的方法（超过 50 行）
- ❌ try 嵌套 try
- ❌ 重复代码
- ❌ 职责不单一
- ❌ 魔法数字和字符串
- ❌ 全局变量滥用
- ❌ 注释显而易见的代码
- ❌ 缺少文档字符串
- ❌ 异常处理不当（吞掉异常）
- ❌ 硬编码配置信息

推荐的模式：
- ✅ 守护判断（提前返回）
- ✅ 方法拆分（单一职责）
- ✅ 策略模式（处理不同场景）
- ✅ 依赖注入
- ✅ 工厂模式（创建对象）

## 5. 服务交互规则

### 5.1 调用规则

- **所有服务间通信必须通过LinkGateway进行**，禁止直接调用
- 业务服务可以调用引擎服务，但必须通过LinkGateway转发
- 引擎服务不能直接相互调用，必须通过业务服务层间接交互
- 所有请求必须经过LinkGateway的认证、授权和监控

### 5.2 服务发现

- 服务和引擎必须包含有效的配置文件
- 服务发现前会清空现有服务信息，避免重复计数
- 服务发现结果存储到数据库中
- 支持自动发现和手动注册两种方式

### 5.3 服务验证

- 验证服务配置文件格式的合法性
- 验证服务是否包含必要的字段
- 验证服务数据库连接的有效性
- 验证服务API路径是否冲突

## 6. 日志规范

### 6.1 日志要求

- **强制要求**：所有日志内容必须使用中文
- 使用标准日志级别：DEBUG, INFO, WARNING, ERROR, CRITICAL
- 日志应包含时间戳、级别、模块名、请求ID和具体消息

### 6.2 输出格式

- 控制台输出：显示时间戳（HH:MM:SS）、级别、模块名、请求ID和消息，如`[14:30:25 INFO] LinkGateway [req-123] - 服务发现完成`
- 文件输出：显示完整日期时间、级别、模块名、请求ID和消息，如`2026-01-26 14:30:25 [INFO] ServiceRegistry [req-123] - 服务注册中心初始化成功`

### 6.3 日志文件管理

- **LinkGateway日志**：`log/linkgateway/linkgateway_{yyyyMMdd}.log`
- **服务日志**：`log/services/{service_id}/{service_id}_{yyyyMMdd}.log`
- **引擎日志**：`log/engines/{engine_name}/{engine_name}_{yyyyMMdd}.log`

### 6.4 日志滚动策略

- debug/info级别：按小时滚动，保留24小时
- warning级别：按天滚动，保留3天
- error/critical级别：按天滚动，保留14天

## 7. 数据管理规范

### 7.1 数据存储位置

- **所有数据必须统一存储在根目录的`data`文件夹下**
- 不同组件的数据独立存储在各自的子目录中，避免数据混乱

### 7.2 数据存储结构

- **LinkGateway数据**：`data/linkgateway/`
- **业务服务数据**：`data/services/{service_id}/`
- **引擎数据**：`data/engines/{engine_name}/`

### 7.3 数据访问方式

- 业务服务的数据访问必须通过LinkGateway进行
- 引擎的数据访问由引擎自行管理，但存储位置必须符合规范
- 数据库连接必须正确管理，避免连接泄露

## 8. 数据库管理规则

### 8.1 数据库类型

- 支持SQLite、MySQL和PostgreSQL
- 默认使用SQLite作为开发环境数据库

### 8.2 数据库连接

- 业务服务的数据库由LinkGateway统一管理
- 引擎的数据库由引擎自行管理
- 数据库文件必须存储在`data`目录下对应的子目录中

### 8.3 数据库操作

- 使用SQLAlchemy进行数据库操作
- 遵循ORM最佳实践
- 适当使用事务确保数据一致性

## 9. 服务开发规范

### 9.1 服务目录结构

每个业务服务应在`services`目录下创建独立的文件夹，目录结构如下：

```
services/{service_id}/
├── {service_id}.py       # 服务主文件
├── service.json          # 服务配置文件
├── api.py                # API路由定义
├── core.py               # 核心业务逻辑
├── database.py           # 数据库操作（可选）
└── logger.py             # 日志配置（可选）
```

### 9.2 必须包含的文件

1. **服务主文件**：`{service_id}.py`
   - 实现服务的核心逻辑
   - 定义服务的初始化、启动和停止方法
   - 提供API路由注册

2. **服务配置文件**：`service.json`
   - 包含服务的基本信息
   - 定义服务的API接口
   - 配置数据库连接信息
   - 声明依赖的引擎服务

### 9.3 服务开发要求

1. **初始化**：
   - 加载配置文件
   - 初始化日志记录器
   - 初始化数据库连接（如果需要）
   - 注册API路由

2. **请求处理**：
   - 实现API端点逻辑
   - 调用其他服务或引擎时必须通过LinkGateway
   - 处理异常情况并返回统一格式响应

3. **服务间通信**：
   - 所有对外调用必须通过LinkGateway进行
   - 使用LinkGateway提供的SDK或API进行服务调用
   - 遵循统一的请求和响应格式

## 10. 引擎开发规范

### 10.1 引擎目录结构

每个引擎应在`engines`目录下创建独立的文件夹，目录结构如下：

```
engines/{engine_name}/
├── {engine_name}.py      # 引擎主文件
├── {engine_name}.json    # 引擎配置文件
├── api.py                # API路由定义（可选）
├── core.py               # 核心功能实现
├── database.py           # 数据库操作（可选）
└── logger.py             # 日志配置（推荐）
```

### 10.2 必须包含的文件

1. **引擎主文件**：`{engine_name}.py`
   - 继承自`BaseEngine`类
   - 实现`start()`、`stop()`和`handle_request()`方法
   - 实现`get_api_routes()`、`get_dependencies()`和`health_check()`方法

2. **引擎配置文件**：`{engine_name}.json`
   - 包含引擎的基本信息
   - 定义引擎的API接口
   - 配置数据库连接信息

### 10.3 引擎开发要求

1. **初始化**：
   - 加载配置文件
   - 初始化日志记录器
   - 初始化数据库连接（如果需要）
   - 初始化核心组件

2. **请求处理**：
   - 根据动作类型处理请求
   - 返回统一格式的响应
   - 处理异常情况

3. **API路由**：
   - 定义清晰的API路由
   - 实现API端点方法
   - 提供必要的API文档

4. **注意事项**：
   - 引擎不能直接调用其他引擎
   - 引擎只能通过LinkGateway接收请求
   - 引擎数据必须存储在指定目录

### 10.4 引擎状态管理

引擎具有以下状态：

- **STOPPED**：停止状态
- **STARTING**：启动中
- **RUNNING**：运行中
- **STOPPING**：停止中
- **ERROR**：错误状态

### 10.5 引擎类型

引擎分为两种类型：

- **KERNEL**：内核引擎，内部使用
- **NETWORK**：网络引擎，外部访问

## 11. 开发流程规范

### 11.1 依赖管理

- 使用UV进行依赖管理，禁止使用全局pip
- 在pyproject.toml中声明依赖
- 运行`uv sync`安装依赖

### 11.2 代码风格

- 严格遵循PEP 8代码规范
- 使用一致的代码风格
- 定期进行代码审查

### 11.3 测试

- 为每个功能模块编写测试用例
- 运行测试确保代码质量
- 进行集成测试确保组件间协同工作

### 11.4 版本控制

- 使用Git进行版本控制
- 提交信息清晰、简洁
- 采用合理的分支管理策略

## 12. 插件开发规范

### 12.1 插件概述

插件是LinkGateway的扩展机制，允许在不修改核心代码的情况下添加新功能。插件可以注册路由、添加中间件、扩展服务功能等。

### 12.2 插件目录结构

插件文件应放置在项目根目录的`plugins`文件夹下，每个插件为一个独立的Python文件：

```
plugins/
├── sample_plugin.py      # 示例插件
└── another_plugin.py     # 另一个插件
```

### 12.3 插件开发要求

1. **基类继承**：插件类必须继承自`Plugin`基类
2. **方法实现**：必须实现`initialize()`和`shutdown()`方法
3. **命名规范**：插件文件名应为非下划线开头的`.py`文件
4. **依赖管理**：插件可以声明依赖的其他插件

### 12.4 插件开发示例

```python
# plugins/sample_plugin.py
from LinkGateway.plugin import Plugin

class SamplePlugin(Plugin):
    def __init__(self, gateway):
        super().__init__(gateway)
        self.dependencies = []  # 插件依赖列表
    
    def initialize(self) -> bool:
        """
        初始化插件
        
        Returns:
            bool: 初始化成功返回True，失败返回False
        """
        self.logger.info("SamplePlugin 初始化")
        
        # 注册路由
        @self.gateway.app.get("/sample")
        async def sample_endpoint():
            return {"message": "Sample plugin endpoint"}
        
        return True
    
    def shutdown(self) -> bool:
        """
        关闭插件
        
        Returns:
            bool: 关闭成功返回True，失败返回False
        """
        self.logger.info("SamplePlugin 关闭")
        return True
    
    def reload(self) -> bool:
        """
        重新加载插件
        
        Returns:
            bool: 重新加载成功返回True，失败返回False
        """
        try:
            self.logger.info("重新加载SamplePlugin")
            self.shutdown()
            return self.initialize()
        except Exception as e:
            self.logger.error(f"重新加载插件失败: {str(e)}")
            return False
    
    def on_service_reloaded(self, service_id: str) -> None:
        """
        服务重载时的回调方法
        
        Args:
            service_id: 重载的服务ID
        """
        self.logger.info(f"服务 {service_id} 已重载")
    
    def on_api_mapped(self) -> None:
        """
        API映射完成时的回调方法
        """
        self.logger.info("API映射完成")
```

### 12.5 插件加载逻辑

1. **目录扫描**：LinkGateway启动时，插件管理器会扫描`plugins`目录下的所有Python文件
2. **动态导入**：使用Python的`importlib`动态导入每个插件文件
3. **实例创建**：为每个找到的Plugin子类创建实例
4. **依赖检查**：检查插件的依赖是否满足
5. **初始化调用**：调用插件的`initialize()`方法进行初始化
6. **注册管理**：将初始化成功的插件注册到插件管理器中

### 12.6 插件生命周期

1. **加载阶段**：LinkGateway启动时加载插件
2. **运行阶段**：插件在LinkGateway运行期间提供功能
3. **热重载**：插件文件修改后可以自动重新加载
4. **关闭阶段**：LinkGateway关闭时，调用插件的`shutdown()`方法释放资源

### 12.7 插件访问方式

插件可以通过以下方式访问LinkGateway的功能：

- `self.gateway.app`：FastAPI应用实例
- `self.gateway.registry`：服务注册中心
- `self.gateway.api_mapper`：API映射器
- `self.gateway.logger`：日志记录器

### 12.8 注意事项

- 插件应避免修改LinkGateway的核心功能
- 插件之间可以声明依赖关系
- 插件应遵循与核心代码相同的代码规范
- 插件应适当处理异常，避免影响LinkGateway的正常运行

## 13. 部署规范

### 13.1 环境要求

- Python 3.10+
- UV依赖管理工具
- 适当的系统权限

### 13.2 配置管理

- 统一的配置文件格式
- 敏感配置使用环境变量
- 配置验证确保正确性

### 13.3 启动命令

- 使用uvicorn启动应用
- 配置适当的启动参数
- 确保监控和日志配置正确

## 14. 开发日记规范

### 14.1 要求

- **强制要求**：每次开发完成后必须填写开发日记
- 开发日记用于记录开发过程中的经验、问题和解决方案，促进团队知识共享

### 14.2 内容要求

开发日记应包含以下内容：

1. **开发概述**：简要描述本次开发的内容和目标
2. **问题与解决方案**：记录开发过程中遇到的问题及解决方案
3. **踩坑与避雷**：记录开发过程中踩过的坑和需要避雷的事项
4. **心得与感悟**：分享开发过程中的心得体会和经验总结

### 14.3 存储要求

- 开发日记存储在项目根目录的`docs/dev_diaries/`文件夹下
- 文件名格式：`{yyyyMMdd}_{开发者名称}_{开发内容简述}.md`
- 采用Markdown格式编写

## 15. 开发教训与最佳实践

### 15.1 模块化设计

- 每个功能模块独立成文件，职责单一
- 模块间通过清晰的接口通信
- 避免循环依赖
- 遵循高内聚、低耦合原则

### 15.2 日志管理

- 使用合适的日志级别
- 日志格式统一，包含时间戳、级别、模块和消息
- 控制台输出和文件输出分离
- 避免在日志中泄露敏感信息

### 15.3 数据管理

- 所有数据统一存储在`data`文件夹下
- 不同组件的数据独立存储在各自子目录
- 使用合适的数据库类型
- 正确管理数据库连接，避免泄露

### 15.4 代码质量

- 遵循PEP 8代码风格规范
- 为每个类、函数和方法添加文档字符串
- 复杂逻辑添加注释
- 使用有意义的变量和函数名
- 保持代码简洁，避免过度设计

### 15.5 安全性

- 不要暴露敏感信息
- 实施适当的认证和授权机制
- 防止SQL注入和XSS攻击

### 15.6 性能优化

- 合理使用缓存策略
- 优化数据库查询
- 避免不必要的计算

---

**最后更新时间**：2026-01-27
**编写者**：AI开发助手
**适用范围**：LinkGateway项目所有开发
**规范要求**：所有开发者必须严格遵守本规范，确保项目的一致性和可维护性