# å®¹å™¨é•œåƒç®¡ç†è§„èŒƒ

## ğŸ“¦ é•œåƒä»“åº“é…ç½®

### é•œåƒä»“åº“åœ°å€
- **ä»“åº“åœ°å€**: `crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com`
- **å‘½åç©ºé—´**: `jamsyan`
- **é¡¹ç›®åç§°**: `myblog`

## ğŸ·ï¸ é•œåƒå‘½åè§„èŒƒ

### å‘½åæ ¼å¼
```
{registry}/{namespace}/{project}-{service}:{environment}-{version}
```

### å‘½åç¤ºä¾‹

#### åç«¯é•œåƒ
- å¼€å‘ç¯å¢ƒ: `crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:dev-latest`
- é¢„å‘å¸ƒç¯å¢ƒ: `crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:staging-v1.0.0`
- ç”Ÿäº§ç¯å¢ƒ: `crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:prod-v1.2.3`

#### å‰ç«¯é•œåƒ
- å¼€å‘ç¯å¢ƒ: `crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-frontend:dev-latest`
- é¢„å‘å¸ƒç¯å¢ƒ: `crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-frontend:staging-v1.0.0`
- ç”Ÿäº§ç¯å¢ƒ: `crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-frontend:prod-v1.2.3`

## ğŸ·ï¸ é•œåƒæ ‡ç­¾ç­–ç•¥

### æ ‡ç­¾ç±»å‹

#### 1. ç¯å¢ƒæ ‡ç­¾
- `dev-latest`: å¼€å‘ç¯å¢ƒæœ€æ–°ç‰ˆæœ¬
- `staging-latest`: é¢„å‘å¸ƒç¯å¢ƒæœ€æ–°ç‰ˆæœ¬
- `prod-latest`: ç”Ÿäº§ç¯å¢ƒæœ€æ–°ç‰ˆæœ¬

#### 2. ç‰ˆæœ¬æ ‡ç­¾
- `v{major}.{minor}.{patch}`: è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œå¦‚ `v1.0.0`, `v1.2.3`
- `v{major}.{minor}`: ä¸»ç‰ˆæœ¬å’Œæ¬¡ç‰ˆæœ¬ï¼Œå¦‚ `v1.0`, `v1.2`

#### 3. åˆ†æ”¯æ ‡ç­¾
- `{branch}-sha{commit}`: åŸºäºåˆ†æ”¯å’Œæäº¤å“ˆå¸Œçš„æ ‡ç­¾ï¼Œå¦‚ `develop-sha1234567`
- `main-sha1234567`: main åˆ†æ”¯çš„æäº¤æ ‡ç­¾

#### 4. PR æ ‡ç­¾
- `pr-{number}`: Pull Request æ ‡ç­¾ï¼Œå¦‚ `pr-123`

### æ ‡ç­¾ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | æ¨èæ ‡ç­¾ | è¯´æ˜ |
|------|---------|------|
| æœ¬åœ°å¼€å‘ | `dev-latest` | å¼€å‘ç¯å¢ƒå¿«é€Ÿè¿­ä»£ |
| åŠŸèƒ½æµ‹è¯• | `feature-xxx-sha123` | ç‰¹å®šåŠŸèƒ½åˆ†æ”¯æµ‹è¯• |
| é¢„å‘å¸ƒ | `staging-v1.0.0` | ç‰ˆæœ¬åŒ–é¢„å‘å¸ƒ |
| ç”Ÿäº§éƒ¨ç½² | `prod-v1.0.0` | ç‰ˆæœ¬åŒ–ç”Ÿäº§éƒ¨ç½² |
| å›æ»š | `prod-v0.9.9` | å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ |

## ğŸš€ é•œåƒæ„å»ºæµç¨‹

### CI/CD è‡ªåŠ¨æ„å»º

#### è§¦å‘æ¡ä»¶
- **ä»£ç æ£€æŸ¥**ï¼šæ¨é€åˆ°ä»»ä½•åˆ†æ”¯æˆ–åˆ›å»º Pull Request æ—¶è§¦å‘
- **é•œåƒæ„å»º**ï¼šä»¥ä¸‹æƒ…å†µè§¦å‘
  - æ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ `v1.0.0`ï¼‰â†’ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  - Pull Request åˆå¹¶åˆ° main åˆ†æ”¯ â†’ é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²
  - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰â†’ æŒ‰éœ€æ„å»º

#### æ„å»ºæµç¨‹
1. **ä»£ç æ£€å‡º**: æ£€å‡ºæœ€æ–°ä»£ç 
2. **ä¾èµ–å®‰è£…**: å®‰è£…é¡¹ç›®ä¾èµ–
3. **ä»£ç æ£€æŸ¥**: è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
4. **é•œåƒæ„å»º**: ä½¿ç”¨ Docker Buildx æ„å»ºå¤šæ¶æ„é•œåƒ
5. **å®‰å…¨æ‰«æ**: ä½¿ç”¨ Trivy è¿›è¡Œæ¼æ´æ‰«æ
6. **é•œåƒæ¨é€**: æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“
7. **è‡ªåŠ¨éƒ¨ç½²**: æ ¹æ®åˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²åˆ°å¯¹åº”ç¯å¢ƒ

### æœ¬åœ°æ„å»º

#### æ„å»ºåç«¯é•œåƒ
```bash
docker build -f docker/Dockerfile.backend -t jamsyan/myblog-backend:dev-latest .
```

#### æ„å»ºå‰ç«¯é•œåƒ
```bash
docker build -f docker/Dockerfile.frontend -t jamsyan/myblog-frontend:dev-latest .
```

#### æ¨é€åˆ°é•œåƒä»“åº“
```bash
docker login crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com
docker tag jamsyan/myblog-backend:dev-latest crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:dev-latest
docker push crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:dev-latest
```

## ğŸ“¦ Docker Compose éƒ¨ç½²

### å¼€å‘ç¯å¢ƒéƒ¨ç½²
```bash
cd docker && docker-compose up -d
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡æŒ‡å®šé•œåƒæ ‡ç­¾
export FRONTEND_IMAGE=crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-frontend:prod-v1.0.0
export BACKEND_IMAGE=crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:prod-v1.0.0
cd docker && docker-compose up -d
### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
cd docker && docker-compose ps
```

### æŸ¥çœ‹æ—¥å¿—
```bash
cd docker && docker-compose logs -f
```

### åœæ­¢æœåŠ¡
```bash
cd docker && docker-compose down
```

## ğŸ” é•œåƒä»“åº“è®¤è¯

### ç™»å½•é•œåƒä»“åº“
```bash
docker login crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com
```

### GitHub Secrets é…ç½®
åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š
- `ALIYUN_USERNAME`: é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“ç”¨æˆ·å
- `ALIYUN_PASSWORD`: é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“å¯†ç 

## ğŸ§¹ é•œåƒæ¸…ç†

### æ¸…ç†æœ¬åœ°æœªä½¿ç”¨çš„é•œåƒ
```bash
docker image prune -a
```

### æ¸…ç†æŒ‡å®šæ ‡ç­¾çš„é•œåƒ
```bash
docker rmi crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:dev-latest
```

### æ¸…ç†è¿œç¨‹ä»“åº“çš„æ—§é•œåƒ
å»ºè®®ä¿ç•™æœ€è¿‘ 10 ä¸ªç‰ˆæœ¬çš„é•œåƒï¼Œå®šæœŸæ¸…ç†æ—§ç‰ˆæœ¬ã€‚

## ğŸ“Š é•œåƒç‰ˆæœ¬ç®¡ç†

### ç‰ˆæœ¬å·è§„èŒƒ
éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬ 2.0.0](https://semver.org/lang/zh-CN/) è§„èŒƒï¼š
- `MAJOR.MINOR.PATCH`
- ä¸»ç‰ˆæœ¬å·ï¼šä¸å…¼å®¹çš„ API ä¿®æ”¹
- æ¬¡ç‰ˆæœ¬å·ï¼šå‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- ä¿®è®¢å·ï¼šå‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£

### å‘å¸ƒæ–°ç‰ˆæœ¬
1. æ›´æ–°ç‰ˆæœ¬å·
2. åˆ›å»º Git æ ‡ç­¾: `git tag v1.0.0`
3. æ¨é€æ ‡ç­¾: `git push origin v1.0.0`
4. CI/CD è‡ªåŠ¨æ„å»ºå¹¶æ¨é€é•œåƒ

## ğŸ” é•œåƒå®‰å…¨

### å®‰å…¨æ‰«æ
æ¯æ¬¡æ„å»ºåè‡ªåŠ¨ä½¿ç”¨ Trivy è¿›è¡Œå®‰å…¨æ‰«æï¼Œæ‰«æç»“æœä¼šä¸Šä¼ åˆ° GitHub Securityã€‚

### æŸ¥çœ‹æ‰«æç»“æœ
åœ¨ GitHub ä»“åº“çš„ Security æ ‡ç­¾é¡µæŸ¥çœ‹æ‰«ææŠ¥å‘Šã€‚

### å®‰å…¨æœ€ä½³å®è·µ
- å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ
- ä½¿ç”¨æœ€å°åŒ–é•œåƒï¼ˆå¦‚ alpineï¼‰
- æ‰«æé•œåƒæ¼æ´å¹¶åŠæ—¶ä¿®å¤
- ä¸è¦åœ¨é•œåƒä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Ÿ
```bash
docker inspect crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:dev-latest
```

### Q2: å¦‚ä½•å›æ»šåˆ°ä¹‹å‰çš„é•œåƒç‰ˆæœ¬ï¼Ÿ
ä¿®æ”¹ docker-compose.yml ä¸­çš„é•œåƒæ ‡ç­¾ä¸ºæ—§ç‰ˆæœ¬ï¼Œç„¶åé‡æ–°éƒ¨ç½²ï¼š
```bash
docker-compose down
docker-compose up -d
```

### Q3: å¦‚ä½•æŸ¥çœ‹é•œåƒçš„æ„å»ºå†å²ï¼Ÿ
```bash
docker history crpi-furbxf8d6ydk7jxx.cn-shanghai.personal.cr.aliyuncs.com/jamsyan/myblog-backend:dev-latest
```

### Q4: å¦‚ä½•ä¼˜åŒ–é•œåƒå¤§å°ï¼Ÿ
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
- æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶å’Œç¼“å­˜
- ä½¿ç”¨ .dockerignore æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
- é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡æ–‡æ¡£](https://help.aliyun.com/product/60716.html)
- [GitHub Actions æ–‡æ¡£](https://docs.github.com/en/actions)
